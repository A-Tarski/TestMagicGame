<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Движение Шарика в Невесомости</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            height: 100%;
            width: 100%;
            position: relative;
            font-family: Arial, sans-serif;
        }
        #canvas {
            display: block;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
            color: #fff;
        }
        #startButton, #controlButton {
            padding: 15px 30px;
            font-size: 20px;
            color: #fff;
            background-color: rgba(0, 123, 255, 0.8);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        #startButton:hover, #controlButton:hover {
            background-color: rgba(0, 123, 255, 1);
        }
        #version {
            font-size: 16px;
            color: #ccc;
        }
        .circle-silhouette {
            position: absolute;
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            pointer-events: none;
            animation: fadeOut 5s forwards;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        @keyframes fadeOut {
            from { opacity: 0.7; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="startButton">Начать</button>
        <button id="controlButton" disabled>Управлять шариком</button>
        <div id="version">Версия: 1.3</div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const startButton = document.getElementById('startButton');
        const controlButton = document.getElementById('controlButton');
        const versionDiv = document.getElementById('version');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let isControlling = false;

        // Установка размера канваса
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Начальные параметры шарика
        let ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 20,
            color: 'radial-gradient(circle, rgba(255,0,150,1) 0%, rgba(0,204,255,1) 100%)',
            trail: []
        };

        // Параметры движения
        let velocity = { x: 0, y: 0 };
        const friction = 0.96;
        const accelerationFactor = 0.15;
        const stopThreshold = 0.05; // Порог для остановки шарика

        // Функция рисования шарика и следа
        function draw() {
            ball.trail.push({ x: ball.x, y: ball.y });
            if (ball.trail.length > 100) {
                ball.trail.shift();
            }

            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            if (ball.trail.length > 1) {
                ctx.moveTo(ball.trail[0].x, ball.trail[0].y);
                for (let i = 1; i < ball.trail.length; i++) {
                    ctx.lineTo(ball.trail[i].x, ball.trail[i].y);
                }
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            const gradient = ctx.createRadialGradient(ball.x - 5, ball.y - 5, ball.radius * 0.1, ball.x, ball.y, ball.radius);
            gradient.addColorStop(0, '#ff0096');
            gradient.addColorStop(1, '#00ccff');

            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 20;
            ctx.shadowColor = 'rgba(0, 204, 255, 0.7)';
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function update() {
            ball.x += velocity.x;
            ball.y += velocity.y;

            velocity.x *= friction;
            velocity.y *= friction;

            // Остановка шарика при низкой скорости
            if (Math.abs(velocity.x) < stopThreshold) velocity.x = 0;
            if (Math.abs(velocity.y) < stopThreshold) velocity.y = 0;

            if (ball.x < ball.radius) {
                ball.x = ball.radius;
                velocity.x = 0;
            } else if (ball.x > canvas.width - ball.radius) {
                ball.x = canvas.width - ball.radius;
                velocity.x = 0;
            }

            if (ball.y < ball.radius) {
                ball.y = ball.radius;
                velocity.y = 0;
            } else if (ball.y > canvas.height - ball.radius) {
                ball.y = canvas.height - ball.radius;
                velocity.y = 0;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            draw();
        }

        function handleMotion(event) {
            if (!isControlling) return;

            const acceleration = event.acceleration;
            if (acceleration) {
                velocity.x += acceleration.x * accelerationFactor;
                velocity.y -= acceleration.y * accelerationFactor;
            }
        }

        function toggleControl() {
            if (!isControlling) {
                isControlling = true;
                controlButton.textContent = 'Остановить управление';
                navigator.vibrate(100);
            } else {
                isControlling = false;
                controlButton.textContent = 'Управлять шариком';
                navigator.vibrate(200);
            }
        }

        function requestMotionPermission() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('devicemotion', handleMotion);
                            startButton.style.display = 'none';
                            controlButton.disabled = false;
                            animate();
                        } else {
                            alert('Доступ к датчикам движения отклонён.');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка запроса разрешения:', error);
                        alert('Произошла ошибка при запросе доступа к датчикам движения.');
                    });
            } else {
                window.addEventListener('devicemotion', handleMotion);
                startButton.style.display = 'none';
                controlButton.disabled = false;
                animate();
            }
        }

        startButton.addEventListener('click', requestMotionPermission);
        controlButton.addEventListener('click', toggleControl);
    </script>
</body>
</html>
