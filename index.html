<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Движение Шарика в Невесомости</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            height: 100%;
            width: 100%;
            position: relative;
            font-family: Arial, sans-serif;
        }
        #canvas {
            display: block;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 10;
            color: #fff;
        }
        #startButton, #controlButton {
            padding: 15px 30px;
            font-size: 20px;
            color: #fff;
            background-color: rgba(0, 123, 255, 0.8);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        #startButton:hover, #controlButton:hover {
            background-color: rgba(0, 123, 255, 1);
        }
        #version {
            font-size: 16px;
            color: #ccc;
        }
        .circle-silhouette {
            position: absolute;
            border: 3px solid rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            pointer-events: none;
            animation: fadeOut 5s forwards;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        @keyframes fadeOut {
            from { opacity: 0.7; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="startButton">Начать</button>
        <button id="controlButton" disabled>Управлять шариком</button>
        <div id="version">Версия: 1.3</div>
    </div>
    <canvas id="canvas"></canvas>

    <script>
        const startButton = document.getElementById('startButton');
        const controlButton = document.getElementById('controlButton');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let isControlling = false;
        let hasCompletedCircle = false;

        // Установка размера канваса
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Начальные параметры шарика
        let ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 20,
            trail: [],
            homeX: canvas.width / 2,
            homeY: canvas.height / 2
        };

        // Параметры движения
        let velocity = { x: 0, y: 0 };
        const friction = 0.96;
        const accelerationFactor = 0.15;
        const stopThreshold = 0.05; // Порог для остановки шарика
        const returnSpeed = 0.02;  // Скорость возврата к центру

        function distance(x1, y1, x2, y2) {
            return Math.sqrt((x1 - x2) ** 2 + (y1 - y2) ** 2);
        }

        // Функция рисования шарика и следа
        function draw() {
            ball.trail.push({ x: ball.x, y: ball.y });
            if (ball.trail.length > 100) {
                ball.trail.shift();
            }

            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.beginPath();
            if (ball.trail.length > 1) {
                ctx.moveTo(ball.trail[0].x, ball.trail[0].y);
                for (let i = 1; i < ball.trail.length; i++) {
                    ctx.lineTo(ball.trail[i].x, ball.trail[i].y);
                }
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }

            const gradient = ctx.createRadialGradient(ball.x - 5, ball.y - 5, ball.radius * 0.1, ball.x, ball.y, ball.radius);
            gradient.addColorStop(0, '#ff0096');
            gradient.addColorStop(1, '#00ccff');

            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = gradient;
            ctx.shadowBlur = 20;
            ctx.shadowColor = 'rgba(0, 204, 255, 0.7)';
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function update() {
            if (!isControlling) {
                // Возвращение шарика в центр
                velocity.x += (ball.homeX - ball.x) * returnSpeed;
                velocity.y += (ball.homeY - ball.y) * returnSpeed;
            }

            ball.x += velocity.x;
            ball.y += velocity.y;

            velocity.x *= friction;
            velocity.y *= friction;

            // Остановка шарика при низкой скорости
            if (Math.abs(velocity.x) < stopThreshold) velocity.x = 0;
            if (Math.abs(velocity.y) < stopThreshold) velocity.y = 0;

            // Проверка на полный круг
            if (!hasCompletedCircle && distance(ball.x, ball.y, ball.homeX, ball.homeY) < ball.radius) {
                hasCompletedCircle = true;
                triggerCelebration();
            } else if (hasCompletedCircle && distance(ball.x, ball.y, ball.homeX, ball.homeY) > ball.radius * 2) {
                hasCompletedCircle = false;
            }
        }

        function triggerCelebration() {
            navigator.vibrate(300);
            for (let i = 0; i < 20; i++) {
                createParticle(ball.x, ball.y);
            }
        }

        function createParticle(x, y) {
            const particle = {
                x,
                y,
                radius: Math.random() * 5 + 2,
                color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                velocity: {
                    x: Math.random() * 4 - 2,
                    y: Math.random() * 4 - 2
                },
                life: 100
            };

            function drawParticle() {
                if (particle.life <= 0) return;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                ctx.fillStyle = particle.color;
                ctx.fill();
            }

            function updateParticle() {
                particle.x += particle.velocity.x;
                particle.y += particle.velocity.y;
                particle.life--;
            }

            function animateParticle() {
                if (particle.life > 0) {
                    drawParticle();
                    updateParticle();
                    requestAnimationFrame(animateParticle);
                }
            }

            animateParticle();
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            draw();
        }

        function handleMotion(event) {
            if (!isControlling) return;

            const acceleration = event.acceleration;
            if (acceleration) {
                velocity.x += acceleration.x * accelerationFactor;
                velocity.y -= acceleration.y * accelerationFactor;
            }
        }

        function toggleControl() {
            if (!isControlling) {
                isControlling = true;
                controlButton.textContent = 'Остановить управление';
                navigator.vibrate(100);
            } else {
                isControlling = false;
                controlButton.textContent = 'Управлять шариком';
                navigator.vibrate(200);
            }
        }

        function requestMotionPermission() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            window.addEventListener('devicemotion', handleMotion);
                            startButton.style.display = 'none';
                            controlButton.disabled = false;
                            animate();
                        } else {
                            alert('Доступ к датчикам движения отклонён.');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка запроса разрешения:', error);
                        alert('Произошла ошибка при запросе доступа к датчикам движения.');
                    });
            } else {
                window.addEventListener('devicemotion', handleMotion);
                startButton.style.display = 'none';
                controlButton.disabled = false;
                animate();
            }
        }

        startButton.addEventListener('click', requestMotionPermission);
        controlButton.addEventListener('click', toggleControl);
    </script>
</body>
</html>
